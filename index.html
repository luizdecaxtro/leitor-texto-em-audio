/* ... (Seu c√≥digo HTML e CSS permanecem os mesmos) ... */

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let synth = window.speechSynthesis;
        let utterance = null;
        let isPaused = false;
        let voices = [];
        let audioContext = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let isRecording = false;
        let destination = null; // Mantenha esta vari√°vel
        
        // ... (loadVoices e todas as fun√ß√µes de carregamento de arquivo e sliders permanecem as mesmas) ...

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function recordAndPlay() {
            let text = document.getElementById('textInput').value;

            if (!text) {
                updateStatus('‚ùå Por favor, insira algum texto primeiro!');
                return;
            }

            // 1. Parar qualquer reprodu√ß√£o ou grava√ß√£o anterior
            stopText(); // Garante que a s√≠ntese anterior seja cancelada
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('audioPreview').classList.remove('active');
            audioBlob = null;
            audioChunks = [];


            try {
                // 2. Inicializar AudioContext e MediaRecorder
                // Essa √© a parte "experimental" que s√≥ funciona em navegadores espec√≠ficos (Chrome/Edge) 
                // e em algumas vers√µes, pois tenta capturar a sa√≠da da API de Fala.
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                destination = audioContext.createMediaStreamDestination();
                
                let options = { mimeType: 'audio/webm;codecs=opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'audio/webm' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = {}; // Deixa o navegador escolher o melhor
                    }
                }
                
                mediaRecorder = new MediaRecorder(destination.stream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    // Ap√≥s a grava√ß√£o ser interrompida (por onend ou stop manual)
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    document.getElementById('audioPlayer').src = audioUrl;
                    document.getElementById('audioPreview').classList.add('active');
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('recordBtn').classList.remove('recording');
                    document.getElementById('recordingInfo').classList.remove('active');
                    isRecording = false;

                    updateStatus('‚úÖ Grava√ß√£o conclu√≠da! Clique em "Baixar √Åudio" para salvar.');
                };

                // 3. Iniciar grava√ß√£o e configurar a fala
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingInfo').classList.add('active');
                updateStatus('üî¥ Gravando...');

                // Preparar texto
                text = text.replace(/\n\n+/g, '.\n\n').replace(/\n/g, '. ');

                // Criar utterance
                utterance = new SpeechSynthesisUtterance(text);
                let voiceIndex = document.getElementById('voiceSelect').value;
                utterance.voice = voices[voiceIndex] || voices[0];
                utterance.rate = parseFloat(document.getElementById('rateSlider').value);
                utterance.pitch = parseFloat(document.getElementById('pitchSlider').value);
                utterance.volume = parseFloat(document.getElementById('volumeSlider').value);
                
                // *** AQUI EST√Å A PARTE CHAVE DA CORRE√á√ÉO ***
                // Tenta rotear o √°udio do sintetizador para o destino do gravador.
                // Isso requer a interface (n√£o-padr√£o) "onboundary" e s√≥ funciona em Chrome/Edge.
                
                let streamNode = null;

                utterance.onstart = () => {
                     // Tenta pegar o n√≥ de √°udio do sintetizador de fala (EXPERIMENTAL)
                    if (synth.synthesisStream) {
                        streamNode = audioContext.createMediaStreamSource(synth.synthesisStream);
                        streamNode.connect(destination);
                        updateStatus('üî¥ Gravando... (Conex√£o estabelecida)');
                    }
                };


                utterance.onend = function() {
                    // Parar grava√ß√£o ap√≥s um pequeno delay para garantir que o √∫ltimo som seja capturado
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                            mediaRecorder.stop();
                        }
                        if (streamNode) {
                            streamNode.disconnect(destination);
                        }
                    }, 500);
                };

                utterance.onerror = function(e) {
                    updateStatus('‚ùå Erro ao reproduzir: ' + e.error);
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                };

                // 4. Iniciar reprodu√ß√£o (que esperamos que seja capturada)
                synth.speak(utterance);

            } catch (error) {
                updateStatus('‚ùå Erro fatal ao iniciar grava√ß√£o: ' + error.message);
                console.error('Erro:', error);
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingInfo').classList.remove('active');
                isRecording = false;
            }
        }

        // ... (downloadAudio, playText, pauseText, stopText permanecem os mesmos) ...

        function stopText() {
            if (synth.speaking) {
                synth.cancel();
                isPaused = false;
                updateStatus('‚èπÔ∏è Parado');
            }
            
            // Adicionado para interromper a grava√ß√£o se estiver ativa
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recordingInfo').classList.remove('active');
        }

    </script>
</body>
</html>

