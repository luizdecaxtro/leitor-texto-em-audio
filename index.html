<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Textos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .file-input-wrapper {
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin-right: 10px;
        }

        .file-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .back-to-site-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .back-to-site-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .btn-play {
            background: #28a745;
        }

        .btn-play:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-pause {
            background: #ffc107;
        }

        .btn-pause:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-stop {
            background: #dc3545;
        }

        .btn-stop:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-record {
            background: #17a2b8;
        }

        .btn-record:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-record.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-download {
            background: #6c757d;
        }

        .btn-download:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-download:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        .settings {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .setting-group {
            flex: 1;
            min-width: 200px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .setting-group select,
        .setting-group input[type="range"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .text-display {
            padding: 30px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.8;
            font-size: 18px;
            color: #212529;
        }

        .text-display:empty::before {
            content: "Carregue um arquivo de texto ou cole seu texto aqui...";
            color: #adb5bd;
            font-style: italic;
        }

        .textarea-input {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .status {
            padding: 15px 30px;
            background: #e9ecef;
            color: #495057;
            font-weight: bold;
            text-align: center;
        }

        .value-display {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: bold;
        }

        .recording-info {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #0c5460;
            display: none;
        }

        .recording-info.active {
            display: block;
        }

        .audio-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .audio-preview.active {
            display: block;
        }

        .audio-preview audio {
            width: 100%;
            margin-top: 10px;
        }

        .info-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #856404;
        }

        .warning-box {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ LojasDeCastro</h1>
            <h2>üìñ Leitor de Textos em √°udio</h2>
            <h2>üìñ Voc√™ s√≥ vai precisar carregar o texto e ouvir</h2>
            <p>Carregue um arquivo ou digite seu texto para ouvir</p>
            <p>Voc√™ tamb√©m pode escolher o narrador com voz masculina ou feminina</p>
            <p>Escolha abaixo, no campo 'voz': a voz, a velocidade e o tom</p>
            <p>üéôÔ∏è <strong>NOVO:</strong> Grave a leitura em arquivo de √°udio!</p>
        </div>

        <div class="controls">
            <div class="file-input-wrapper">            
                <label for="fileInput" class="file-label">üìÅ Carregar Arquivo (TXT, PDF, DOCX)</label>
                <button class="back-to-site-btn" 
                        style="background-color: orange;" 
                        onclick="window.location.href='https://www.lojasdecastro.com.br'">
                    ‚Üê Voltar para LojasDeCastro
                </button>                             
                <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx">
            </div>
            <textarea class="textarea-input" id="textInput" placeholder="Ou digite/cole seu texto aqui..."></textarea>

            <div class="voice-controls">
                <button class="btn-play" onclick="playText()">‚ñ∂Ô∏è Reproduzir</button>
                <button class="btn-pause" onclick="pauseText()">‚è∏Ô∏è Pausar</button>
                <button class="btn-stop" onclick="stopText()">‚èπÔ∏è Parar</button>
                <button class="btn-record" id="recordBtn" onclick="startRecording()">üéôÔ∏è Gravar em √Åudio</button>
                <button class="btn-download" id="downloadBtn" onclick="downloadAudio()" disabled>üíæ Baixar √Åudio</button>
            </div>

            <div class="recording-info" id="recordingInfo">
                <strong>üî¥ Gravando...</strong> A leitura est√° sendo gravada. Aguarde o t√©rmino da leitura.
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è IMPORTANTE:</strong> A grava√ß√£o de √°udio tem limita√ß√µes no navegador:<br>
                ‚Ä¢ <strong>Chrome/Edge:</strong> Grava em formato WebM (pode precisar de convers√£o)<br>
                ‚Ä¢ <strong>Safari:</strong> Pode n√£o funcionar corretamente<br>
                ‚Ä¢ <strong>Firefox:</strong> Grava em formato OGG<br><br>
                <strong>üí° Solu√ß√£o:</strong> Se o arquivo n√£o abrir, use conversores online gratuitos:<br>
                ‚Ä¢ <a href="https://cloudconvert.com" target="_blank">cloudconvert.com</a> (WebM ‚Üí MP3)<br>
                ‚Ä¢ <a href="https://convertio.co" target="_blank">convertio.co</a> (WebM ‚Üí MP3/WAV)<br>
                ‚Ä¢ Ou use o VLC Media Player para reproduzir arquivos WebM
            </div>

            <div class="info-box">
                <strong>üí° Como gravar:</strong><br>
                1. Digite ou carregue seu texto<br>
                2. Configure a voz, velocidade e tom desejados<br>
                3. Clique em "Gravar em √Åudio"<br>
                4. Aguarde a leitura completa<br>
                5. Baixe o arquivo e converta se necess√°rio
            </div>

            <div class="audio-preview" id="audioPreview">
                <strong>üéµ Pr√©-visualiza√ß√£o do √Åudio Gravado:</strong>
                <audio controls id="audioPlayer"></audio>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    Formato: <span id="audioFormat">-</span> | 
                    Se n√£o reproduzir, baixe e converta online
                </p>
            </div>

            <div class="settings">
                <div class="setting-group">
                    <label for="voiceSelect">Voz:</label>
                    <select id="voiceSelect"></select>
                </div>
                <div class="setting-group">
                    <label for="rateSlider">Velocidade: <span class="value-display" id="rateValue">1.0x</span></label>
                    <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="setting-group">
                    <label for="pitchSlider">Tom: <span class="value-display" id="pitchValue">1.0</span></label>
                    <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="setting-group">
                    <label for="volumeSlider">Volume: <span class="value-display" id="volumeValue">100%</span></label>
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                </div>
            </div>
        </div>

        <div class="text-display" id="textDisplay"></div>

        <div class="status" id="status">Pronto para ler</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let synth = window.speechSynthesis;
        let utterance = null;
        let isPaused = false;
        let voices = [];
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let isRecording = false;

        function loadVoices() {
            voices = synth.getVoices();
            let voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '';
            
            let ptBRVoices = voices.filter(v => v.lang === 'pt-BR');
            let ptVoices = voices.filter(v => v.lang.startsWith('pt') && v.lang !== 'pt-BR');
            let otherVoices = voices.filter(v => !v.lang.startsWith('pt'));
            
            function getVoiceQuality(voice) {
                const name = voice.name.toLowerCase();
                if (name.includes('neural') || name.includes('premium') || 
                    name.includes('enhanced') || name.includes('natural')) {
                    return 'üåü ';
                }
                if (name.includes('google') || name.includes('microsoft')) {
                    return '‚ú® ';
                }
                return '';
            }
            
            function sortByQuality(voiceList) {
                return voiceList.sort((a, b) => {
                    const qualityA = getVoiceQuality(a);
                    const qualityB = getVoiceQuality(b);
                    if (qualityA && !qualityB) return -1;
                    if (!qualityA && qualityB) return 1;
                    return a.name.localeCompare(b.name);
                });
            }
            
            if (ptBRVoices.length > 0) {
                let optgroup = document.createElement('optgroup');
                optgroup.label = 'Portugu√™s (Brasil) - Recomendado';
                sortByQuality(ptBRVoices).forEach(voice => {
                    let option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)}${voice.name}`;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            if (ptVoices.length > 0) {
                let optgroup = document.createElement('optgroup');
                optgroup.label = 'Portugu√™s';
                sortByQuality(ptVoices).forEach(voice => {
                    let option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)}${voice.name} (${voice.lang})`;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            if (otherVoices.length > 0) {
                let optgroup = document.createElement('optgroup');
                optgroup.label = 'Outros idiomas';
                sortByQuality(otherVoices).forEach(voice => {
                    let option = document.createElement('option');
                    option.value = voices.indexOf(voice);
                    option.textContent = `${getVoiceQuality(voice)}${voice.name} (${voice.lang})`;
                    optgroup.appendChild(option);
                });
                voiceSelect.appendChild(optgroup);
            }
            
            if (ptBRVoices.length > 0) {
                const bestVoice = sortByQuality(ptBRVoices)[0];
                voiceSelect.value = voices.indexOf(bestVoice);
            }
        }

        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        loadVoices();

        document.getElementById('fileInput').addEventListener('change', function(e) {
            let file = e.target.files[0];
            if (file) {
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.txt')) {
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        let text = e.target.result;
                        document.getElementById('textInput').value = text;
                        document.getElementById('textDisplay').textContent = text;
                        updateStatus(`Arquivo "${file.name}" carregado com sucesso!`);
                    };
                    reader.readAsText(file);
                }
                else if (fileName.endsWith('.pdf')) {
                    updateStatus('üìÑ Processando PDF...');
                    let reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = '';
                            
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(' ');
                                fullText += pageText + '\n\n';
                            }
                            
                            document.getElementById('textInput').value = fullText;
                            document.getElementById('textDisplay').textContent = fullText;
                            updateStatus(`‚úÖ PDF "${file.name}" carregado com sucesso! (${pdf.numPages} p√°ginas)`);
                        } catch (error) {
                            updateStatus('‚ùå Erro ao ler PDF: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
                else if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
                    updateStatus('üìù Processando documento Word...');
                    let reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const arrayBuffer = e.target.result;
                            const result = await mammoth.extractRawText({arrayBuffer: arrayBuffer});
                            const text = result.value;
                            
                            document.getElementById('textInput').value = text;
                            document.getElementById('textDisplay').textContent = text;
                            updateStatus(`‚úÖ Documento "${file.name}" carregado com sucesso!`);
                            
                            if (result.messages.length > 0) {
                                console.log('Avisos:', result.messages);
                            }
                        } catch (error) {
                            updateStatus('‚ùå Erro ao ler documento Word: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
                else {
                    updateStatus('‚ùå Formato de arquivo n√£o suportado. Use TXT, PDF ou DOCX.');
                }
            }
        });

        document.getElementById('textInput').addEventListener('input', function() {
            document.getElementById('textDisplay').textContent = this.value;
        });

        document.getElementById('rateSlider').addEventListener('input', function() {
            document.getElementById('rateValue').textContent = this.value + 'x';
        });

        document.getElementById('pitchSlider').addEventListener('input', function() {
            document.getElementById('pitchValue').textContent = this.value;
        });

        document.getElementById('volumeSlider').addEventListener('input', function() {
            document.getElementById('volumeValue').textContent = Math.round(this.value * 100) + '%';
        });

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function startRecording() {
            let text = document.getElementById('textInput').value;
            
            if (!text) {
                updateStatus('‚ùå Por favor, insira algum texto primeiro!');
                return;
            }

            if (isRecording) {
                updateStatus('‚ö†Ô∏è Uma grava√ß√£o j√° est√° em andamento!');
                return;
            }

            try {
                // Solicitar permiss√£o do microfone (necess√°rio para MediaRecorder)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Parar o stream do microfone imediatamente
                stream.getTracks().forEach(track => track.stop());
                
                // Criar um AudioContext e destino
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const destination = audioContext.createMediaStreamDestination();
                
                // Configurar MediaRecorder com melhor formato dispon√≠vel
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                    mimeType = 'audio/ogg;codecs=opus';
                }
                
                mediaRecorder = new MediaRecorder(destination.stream, { 
                    mimeType: mimeType,
                    audioBitsPerSecond: 128000
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('audioPlayer').src = audioUrl;
                    document.getElementById('audioFormat').textContent = mimeType;
                    document.getElementById('audioPreview').classList.add('active');
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('recordingInfo').classList.remove('active');
                    document.getElementById('recordBtn').classList.remove('recording');
                    isRecording = false;
                    audioContext.close();
                    updateStatus('‚úÖ Grava√ß√£o conclu√≠da! Baixe o arquivo e converta se necess√°rio.');
                };
                
                // Iniciar grava√ß√£o
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordingInfo').classList.add('active');
                document.getElementById('recordBtn').classList.add('recording');
                updateStatus('üî¥ Gravando... Aguarde o t√©rmino da leitura.');
                
                // Preparar e iniciar a fala
                text = text.replace(/\n\n+/g, '.\n\n').replace(/\n/g, '. ');
                utterance = new SpeechSynthesisUtterance(text);
                
                let voiceIndex = document.getElementById('voiceSelect').value;
                utterance.voice = voices[voiceIndex] || voices[0];
                utterance.rate = parseFloat(document.getElementById('rateSlider').value);
                utterance.pitch = parseFloat(document.getElementById('pitchSlider').value);
                utterance.volume = parseFloat(document.getElementById('volumeSlider').value);
                
                utterance.onend = function() {
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                            mediaRecorder.stop();
                        }
                    }, 500);
                };
                
                utterance.onerror = function(e) {
                    updateStatus('‚ùå Erro ao reproduzir: ' + e.error);
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                    isRecording = false;
                    document.getElementById('recordBtn').classList.remove('recording');
                };
                
                synth.speak(utterance);
                
            } catch (error) {
                updateStatus('‚ùå Erro ao iniciar grava√ß√£o: ' + error.message);
                console.error('Erro detalhado:', error);
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('recording');
                
                if (error.name === 'NotAllowedError') {
                    alert('Permiss√£o de microfone negada. Por favor, permita o acesso ao microfone para gravar.');
                }
            }
        }

        function downloadAudio() {
            if (audioBlob) {
                const url = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.href = url;
                
                let extension = '.webm';
                const mimeType = audioBlob.type;
                if (mimeType.includes('ogg')) {
                    extension = '.ogg';
                } else if (mimeType.includes('mp4')) {
                    extension = '.mp4';
                } else if (mimeType.includes('wav')) {
                    extension = '.wav';
                }
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.download = `leitura_${timestamp}${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                updateStatus(`üíæ √Åudio baixado! Se n√£o abrir, converta em cloudconvert.com`);
            }
        }

        function playText() {
            let text = document.getElementById('textInput').value;
            
            if (!text) {
                updateStatus('‚ùå Por favor, insira algum texto primeiro!');
                return;
            }

            if (isPaused) {
                synth.resume();
                isPaused = false;
                updateStatus('‚ñ∂Ô∏è Reproduzindo...');
                return;
            }

            stopText();
            text = text.replace(/\n\n+/g, '.\n\n').replace(/\n/g, '. ');

            utterance = new SpeechSynthesisUtterance(text);
            
            let voiceIndex = document.getElementById('voiceSelect').value;
            utterance.voice = voices[voiceIndex] || voices[0];
            utterance.rate = parseFloat(document.getElementById('rateSlider').value);
            utterance.pitch = parseFloat(document.getElementById('pitchSlider').value);
            utterance.volume = parseFloat(document.getElementById('volumeSlider').value);

            utterance.onstart = function() {
                updateStatus('‚ñ∂Ô∏è Reproduzindo...');
            };

            utterance.onend = function() {
                updateStatus('‚úÖ Leitura conclu√≠da!');
            };

            utterance.onerror = function(e) {
                updateStatus('‚ùå Erro ao reproduzir: ' + e.error);
            };

            synth.speak(utterance);
        }

        function pauseText() {
            if (synth.speaking && !isPaused) {
                synth.pause();
                isPaused = true;
                updateStatus('‚è∏Ô∏è Pausado');
            }
        }

        function stopText() {
            if (synth.speaking) {
                synth.cancel();
                isPaused = false;
                updateStatus('‚èπÔ∏è Parado');
            }
        }
    </script>
</body>
</html>


